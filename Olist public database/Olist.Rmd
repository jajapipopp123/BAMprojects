---
title: "Codebook raw and uncleaned"
author: "Naramol (Jaja) Pipoppinyo"
date: "2023-07-17"
output: html_document
---


DATASETS 
*product_category_name_translation.csv* 

*olist-products_dataset.csv* 
- translate the product_category name to English/replace it. (either with R or SQL)

*olist_orders_dataset.csv*
- understanding the time when an order was purchased and when an order was delivered, how does it relate to the customer review? - *olist_order_reviews_dataset*  

*Recommendations*
- customer segmentation for targeted advertisements based on ..



 
```{r}
library("tidymodels")
library("NbClust")
library("GGally")
```
 
 
```{r}
library(readr)

customer_data <- read_csv('olist_customers_dataset.csv')
geolocation <- read_csv('olist_geolocation_dataset.csv')
order_items <- read_csv('olist_order_items_dataset.csv')
order_payments <- read_csv('olist_order_payments_dataset.csv')
products <- read_csv('olist_products_dataset.csv')
sellers <- read_csv('olist_sellers_dataset.csv')
product_category_name_translation <- read_csv('product_category_name_translation.csv')
order_reviews <- read_csv('olist_order_reviews_dataset.csv')
orders <- read_csv('olist_orders_dataset.csv')
delivery <-  read_csv('days_delivered.csv')
final_RFM <-  read_csv('final_RFM.csv')


products <- products[complete.cases(products), ]
final_RFM <- final_RFM[complete.cases(final_RFM), ]
delivery <- delivery[complete.cases(delivery$days_delivered_time), ]

#REMOVING DUPLICATES
has_duplicates <- sum(duplicated(order_items$order_id))
order_reviews <- order_reviews[!duplicated(order_reviews$order_id), ]
has_duplicates <- sum(duplicated(order_items$order_id))
order_items <- order_items[!duplicated(order_items$order_id), ]
has_duplicates <- sum(duplicated(order_payments$order_id))
order_payments <- order_payments[!duplicated(order_payments$order_id), ]
has_duplicates <- sum(duplicated(delivery$order_id))
delivery <- delivery[!duplicated(delivery$order_id), ]
has_duplicates <- sum(duplicated(customer_data$customer_id))

order_items$price 
order_items$freight_value
order_payments$payment_installments
order_reviews$review_score
delivery$days_delivered_time
products$product_name_lenght #productid exists in both order_items and 



```
 

```{r}
library(dplyr)

# Merge the order_items and order_reviews dataframes based on order_id
merged_data <- merge(orders, order_reviews, by = "order_id", how = 'left')
merged_data <- merge(merged_data, order_items, by = "order_id", how = 'left')
merged_data <- merge(merged_data, delivery, by = "order_id", how = 'left')
merged_data <- merge(merged_data, order_payments, by = "order_id", how = 'left')
merged_data <- merge(merged_data, order_items, on='product_id.x', how='left')
merged_data <- merge(merged_data, products, on='product_id.x', how='left')
merged_data <- merge(merged_data, final_RFM, by = "order_id")


merged_data

merged_data <- distinct(merged_data, customer_id.x, .keep_all = TRUE)

# The distinct() function keeps only the first occurrence of each unique customer_id,
# and the .keep_all argument ensures that all columns are retained.

# Now you have the distinct_merged_data data frame without duplicate customer_id entries.
print(merged_data)

```




```{r}


new_df <- select(merged_data, customer_id.x, order_status, price, 
                freight_value, 
                 payment_installments, 
                 review_score.x, product_name_lenght, recency,
                 frequency, monetary, product_photos_qty, product_description_lenght, product_name_lenght, review_comment_message.y)


new_df <- new_df %>%
              filter(order_status == "delivered")

new_df <- select(new_df,customer_id.x, price, 
                 payment_installments, 
                  recency,
                  monetary)
#, product_photos_qty, product_description_lenght, product_name_lenght

sampled_data <- new_df %>%
  sample_n(10000)

#write.csv(sampled_data, "sampled_data.csv")



rownames(sampled_data) <- sampled_data[,1]
sampled_data <-sampled_data[,-1]

```


```{r}
sampled_data  |> ggpairs(progress = FALSE)


```


```{r}
range_recipe <- recipe(~ ., data = sampled_data ) |> 
  step_range(all_numeric())
cw_range <- range_recipe |> prep(sampled_data ) |> bake(new_data = NULL) 


```



```{r}
set.seed(1711)



nc <- NbClust(cw_range  , min.nc = 2, max.nc = 15,
              method = "kmeans", index = "tracew")

df_scree <- data.frame(TraceW = nc$All.index, Cluster = 2:15)
df_scree |> ggplot(aes(x = Cluster, y = TraceW)) + 
  geom_line() + geom_point()
```



5 clusters
```{r}
set.seed(4131)


cw_km5 <- kmeans(cw_range , centers = 5, nstart = 5000)
cw_km6 <- kmeans(cw_range , centers = 6, nstart = 5000)
cw_km7 <- kmeans(cw_range , centers = 7, nstart = 5000)

cw_km5$size
cw_km6$size
cw_km7$size

library(dplyr)



```

```{r}
sampled_data|> ggpairs(mapping = aes(colour = factor(cw_km5$cluster)), progress = FALSE)
sampled_data|> ggpairs(mapping = aes(colour = factor(cw_km6$cluster)), progress = FALSE)
sampled_data|> ggpairs(mapping = aes(colour = factor(cw_km7$cluster)), progress = FALSE)
```
```{r}
library(ggplot2)
cw_aug5 <- sampled_data
cw_aug6 <- sampled_data
cw_aug7 <- sampled_data
cw_aug5$cluster <- factor(cw_km5$cluster)
cw_aug6$cluster <- factor(cw_km6$cluster)
cw_aug7$cluster <- factor(cw_km7$cluster)

cw_aug5 |> ggparcoord(columns = 1:4, scale = "uniminmax",
                     groupColumn = "cluster", alphaLines = 0.8) + 
  facet_wrap(~ cluster) +
  theme(axis.text.x = element_text(size = 4.5),
        axis.title.y = element_blank()) 

ggsave("5clus_plot.png", width = 12, height = 12)  


cw_aug6 |> ggparcoord(columns = 1:4, scale = "uniminmax",
                     groupColumn = "cluster", alphaLines = 0.8) + 
  facet_wrap(~ cluster) +
  theme(axis.text.x = element_text(size = 4.5),
        axis.title.y = element_blank()) 

ggsave("6clus_plot.png", width = 12, height = 12)  

cw_aug7 |> ggparcoord(columns = 1:4, scale = "uniminmax",
                     groupColumn = "cluster", alphaLines = 0.8) + 
  facet_wrap(~ cluster) +
  theme(axis.text.x = element_text(size = 4.5),
        axis.title.y = element_blank()) 

ggsave("7clus_plot.png", width = 12, height = 12)  







```




Geography information
```{r}


sampled_data2 <- sampled_data %>%
  rownames_to_column(var = "customer_id")

sampled_data2$cluster_no <- cw_km6$cluster



geo_merged_df <- merge(sampled_data2 , customer_data, by = "customer_id", how = 'left')

write.csv(geo_merged_df, "geo_merged_df.csv")

```

```{r}
library(dplyr)
library(ggplot2)

# Assuming 'geo_merged_df' is your data frame with customer data

# Step 1: Group by 'cluster_no' and 'customer_zip_code_prefix' and count the number of occurrences
cluster_zip_counts <- geo_merged_df %>%
  group_by(cluster_no, customer_state) %>%
  summarise(count = n())

# Step 2: Create the visualization
ggplot(cluster_zip_counts, aes(x = customer_state, y = count, fill = factor(cluster_no))) +
  geom_bar(stat = "identity") +
  labs(x = "Zipcode", y = "Count", title = "Number of Values per Cluster per State") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}
library(dplyr)
library(ggplot2)

# Assuming 'geo_merged_df' is your data frame with customer data

# Step 1: Group by 'cluster_no' and 'customer_state' and count the number of occurrences
cluster_state_counts <- geo_merged_df %>%
  group_by(cluster_no, customer_state) %>%
  summarise(count = n()) %>%
  ungroup()

# Step 2: Calculate the total count per state
state_totals <- cluster_state_counts %>%
  group_by(customer_state) %>%
  summarise(total_count = sum(count))

# Step 3: Join cluster_state_counts with state_totals and calculate the percentage
cluster_state_counts <- cluster_state_counts %>%
  left_join(state_totals, by = "customer_state") %>%
  mutate(percentage = (count / total_count) * 100)

# Step 4: Create the visualization
ggplot(cluster_state_counts, aes(x = customer_state, y = percentage, fill = factor(cluster_no))) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = sprintf("%.1f%%", percentage)), position = position_stack(vjust = 0.5), size = 2) +  # Add data labels with percentage
  labs(x = "State", y = "Percentage", title = "Percentage of Values per Cluster per State",  fill = "Segment #") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("percent.png", width = 12, height = 12) 

```
```{r}
# Assuming 'geo_merged_df' is your data frame with customer data

# Step 1: Count the number of customers per state
state_counts <- geo_merged_df %>%
  group_by(customer_state) %>%
  summarise(num_customers = n_distinct(customer_id))

# Step 2: Create the bar chart without the legend, sorted in ascending order
ggplot(state_counts, aes(x = reorder(customer_state, num_customers), y = num_customers)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_text(aes(label = num_customers), vjust = -0.5, size = 3) +  # Add data labels
  labs(x = "State", y = "Number of Customers", title = "Number of Sample Customers per State ") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")  # Remove the legend


```

```{r}
library(dplyr)
library(ggplot2)

library(dplyr)
library(ggplot2)

# Assuming 'geo_merged_df' is your data frame with customer data

# Step 1: Group by 'cluster_no' and 'customer_zip_code_prefix' and count the number of occurrences
cluster_zip_counts <- geo_merged_df %>%
  group_by(cluster_no, customer_state) %>%
  summarise(count = n())

# Step 2: Reorder the customer_state based on the total count in descending order
ordered_states <- cluster_zip_counts %>%
  group_by(customer_state) %>%
  summarise(total_count = sum(count)) %>%
  arrange(desc(total_count)) %>%
  pull(customer_state)

cluster_zip_counts$customer_state <- factor(cluster_zip_counts$customer_state, levels = ordered_states)

# Step 3: Create the visualization
ggplot(cluster_zip_counts, aes(x = customer_state, y = count, fill = factor(cluster_no))) +
  geom_bar(stat = "identity") +
  labs(x = "Zipcode", y = "Count", title = "Number of Values per Cluster per Zipcode") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))



```



random forest to predict the cluster # for the rest of the dataset 
```{r}
 #based on customer id: input the other variables from merged_df, use that dataset to predict 

sampled_data2$cluster_no <- cw_km6$cluster

for_rf <- select(merged_data, customer_id.x, order_status, 
                freight_value, 
                 payment_installments, 
                 review_score.x, product_name_lenght, 
                 frequency, product_photos_qty, product_description_lenght, product_name_lenght, days_delivered_time, )

for_rf  <- for_rf  %>%
  rename(customer_id = customer_id.x)

rf_df <-  merge(sampled_data2 , for_rf, by = "customer_id", how = 'left')

```

```{r}
rf_df  <- merge(rf_df ,orders, by = "customer_id", how = 'left')
```

```{r}
#sentiment

senti <- merge(rf_df, order_reviews, by = "order_id", how = 'left')

senti

senti <- senti %>%
  mutate(cluster_no = recode(cluster_no,
                             `1` = "Promising",
                             `2` = "Hibernating",
                             `3` = "Champions",
                             `4` = "Can't lose them",
                             `5` = "Newcomers",
                             `6` = "About to hibernate"))

```



```{r}


# Group the data by 'cluster_no' and 'review_score' and calculate the count
grouped_data <- senti %>%
  group_by(cluster_no, review_score) %>%
  summarise(count = n()) %>%
  ungroup()

# Calculate the percentage for each review_score within each cluster
grouped_data_percent <- grouped_data %>%
  group_by(cluster_no) %>%
  mutate(percentage = count / sum(count) * 100) %>%
  ungroup()

# Plot the stacked bar plot
ggplot(grouped_data_percent, aes(x = as.factor(cluster_no), y = percentage, fill = as.factor(review_score))) +
  geom_bar(stat = 'identity') +
  labs(x = 'Clusters', y = 'Percentage', title = 'Review Scores by Clusters') +
  theme_minimal() +
  scale_fill_discrete(name = 'Review Score') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_text(aes(label = paste0(round(percentage), '%')), 
            position = position_stack(vjust = 0.5))

# Print the first few rows of the percentage data
head(grouped_data_percent)

```


PRODUCTS ANALYSIS:




```{r}
product_df <-  merge(rf_df, order_items, by = "order_id", how = 'left')
product_df <- merge(product_df , products, by = "product_id", how = 'left')



```

```{r}

# Assuming 'top_5_categories' DataFrame contains the top 5 categories per cluster


# Filter the data for cluster one
cluster_one_top_1 <- subset(top_5_categories, cluster_no == 1)
cluster_one_top_2 <- subset(top_5_categories, cluster_no == 2)
cluster_one_top_3 <- subset(top_5_categories, cluster_no == 3)
cluster_one_top_4 <- subset(top_5_categories, cluster_no == 4)

cluster_one_top_5 <- subset(top_5_categories, cluster_no == 5)
cluster_one_top_6 <- subset(top_5_categories, cluster_no == 6)
# Create the bar plot for cluster one
ggplot(cluster_one_top_1, aes(x = fct_inorder(product_category_name.x), y = category_count, fill = factor(cluster_no))) +
  geom_bar(stat = "identity", position = "dodge", fill = "indianred1") +
  labs(x = "Product Category", y = "Count", fill = "Cluster No") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(size = 10)) +
  ggtitle("Top 5 Product Categories for 'Promising'") +
  scale_fill_discrete(name = "Promising ")

ggsave("clus1.png", width = 4, height = 3)  

# Create the bar plot for cluster one
ggplot(cluster_one_top_2, aes(x = fct_inorder(product_category_name.x), y = category_count, fill = factor(cluster_no))) +
  geom_bar(stat = "identity", position = "dodge", fill = "orange3") +
  labs(x = "", y = "", fill = "Cluster No") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(size = 10)) +
  ggtitle("Top 5 Product Categories in 'Hibernating'")  +
  scale_fill_discrete(name = "Hibernating")


ggsave("clus2.png", width = 4, height = 3)  

ggplot(cluster_one_top_3, aes(x = fct_inorder(product_category_name.x), y = category_count, fill = factor(cluster_no))) +
  geom_bar(stat = "identity", position = "dodge", fill = "green") +
  labs(x = "Product Category", y = "Count", fill = "Cluster No") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(size = 10)) +
  ggtitle("Top 5 Product Categories in 'Champions'" )  +
  scale_fill_discrete(name = "Champions")

ggsave("clus3.png", width = 4, height = 3)  

ggplot(cluster_one_top_4, aes(x = fct_inorder(product_category_name.x), y = category_count, fill = factor(cluster_no))) +
  geom_bar(stat = "identity", position = "dodge", fill = "turquoise3") +
  labs(x = "Product Category", y = "", fill = "Cluster No") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(size = 10)) +
  ggtitle("Top 5 Product Categories in 'Can't Lose Them'")  +
  scale_fill_discrete(name = "Can't Lose Them")

ggsave("clus4.png", width = 4, height = 3)  


ggplot(cluster_one_top_5, aes(x = fct_inorder(product_category_name.x), y = category_count, fill = factor(cluster_no))) +
  geom_bar(stat = "identity", position = "dodge", fill = "dodgerblue2") +
  labs(x = "", y = "", fill = "Cluster No") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(size = 10)) +
  ggtitle("Top 5 Product Categories in 'Newcomers'")  +
  scale_fill_discrete(name = "Newcomers")

ggsave("clus5.png", width = 4, height = 3) 

ggplot(cluster_one_top_6, aes(x = fct_inorder(product_category_name.x), y = category_count, fill = factor(cluster_no))) +
  geom_bar(stat = "identity", position = "dodge", fill = "deeppink") +
  labs(x = "Product Category", y = "", fill = "Cluster No") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),plot.title = element_text(size = 10)) +
  ggtitle("Top 5 Product Categories in 'About to Hibernate'")  +
  scale_fill_discrete(name = "About To Hibernate")

ggsave("clus6.png", width = 4, height = 3) 

```


